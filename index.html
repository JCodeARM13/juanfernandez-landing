<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Protocolo VIERNES - Acceso Restringido</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --matrix-green: #00ff41;
      --cyber-blue: #00d4ff;
      --glitch-pink: #ff0080;
      --glitch-cyan: #00ffff;
      --dark-bg: #0a0a0a;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #000;
      color: #f5f5f7;
      overflow: hidden;
    }

    /* Transiciones */
    .fade-in { animation: fadeIn 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
    .fade-out { animation: fadeOut 1.2s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards; }
    .slide-up { animation: slideUp 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
    
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(20px) scale(0.95); } 
      to { opacity: 1; transform: translateY(0) scale(1); } 
    }
    @keyframes fadeOut { 
      from { opacity: 1; transform: scale(1); } 
      to { opacity: 0; transform: scale(0.9); } 
    }
    @keyframes slideUp { 
      from { opacity: 0; transform: translateY(50px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    /* Efecto Matrix */
    #matrix-screen {
      font-family: 'Fira Code', monospace;
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: radial-gradient(ellipse at center, #001a00 0%, #000000 70%);
      z-index: 50;
    }
    .matrix-column {
      position: absolute;
      top: -100%;
      color: var(--matrix-green);
      font-size: 14px;
      line-height: 1.2;
      animation: matrix-fall 3s linear infinite;
      text-shadow: 0 0 5px var(--matrix-green);
      /* MEJORA: Optimización de rendimiento */
      will-change: transform;
    }
    @keyframes matrix-fall {
      to { top: 100vh; }
    }
    #matrix-text { 
      white-space: pre-wrap; 
      color: var(--matrix-green);
      text-shadow: 0 0 10px var(--matrix-green);
      font-size: clamp(0.8rem, 2vw, 1.2rem);
    }
    .blinking-cursor { 
      animation: blink 1s step-end infinite; 
      border-right: 2px solid var(--matrix-green);
    }
    @keyframes blink { 
      50% { border-right-color: transparent; } 
    }

    /* Efectos Glitch */
    #glitch-screen {
      font-family: 'Fira Code', monospace;
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: linear-gradient(45deg, #000000, #1a001a, #001a1a, #000000);
      background-size: 400% 400%;
      animation: bg-shift 5s ease infinite;
      z-index: 40;
    }
    @keyframes bg-shift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* Barra de carga */
    #loading-bar-container { 
      position: absolute; bottom: 8%; left: 10%; width: 80%; height: 8px; 
      background: linear-gradient(90deg, rgba(0,255,65,0.1), rgba(0,212,255,0.1));
      border: 2px solid rgba(0,255,65,0.3); border-radius: 10px; overflow: hidden;
    }
    #loading-bar { 
      width: 0%; height: 100%; 
      background: linear-gradient(90deg, var(--matrix-green), var(--cyber-blue));
      transition: width 8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    /* Pantalla de login */
    .ai-pulse { animation: ai-pulse 2s ease-in-out infinite alternate; }
    @keyframes ai-pulse {
      from { opacity: 0.7; transform: scale(1); filter: drop-shadow(0 0 5px #007bff); }
      to { opacity: 1; transform: scale(1.05); filter: drop-shadow(0 0 15px #007bff); }
    }

    /* Chat */
    #chat-screen {
      background: linear-gradient(135deg, #0a0a0a 0%, #1a0a2e 25%, #16213e 50%, #0f3460 75%, #000000 100%);
      background-size: 400% 400%; animation: gradient-flow 15s ease infinite;
    }
    @keyframes gradient-flow {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    .chat-window {
      width: 95%; max-width: 900px; height: 95vh; max-height: 950px;
      background: rgba(10, 10, 15, 0.7); backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px); border: 2px solid rgba(0, 123, 255, 0.2);
      border-radius: 28px; animation: chat-entrance 1s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes chat-entrance { 
      from { transform: scale(0.8) translateY(50px); opacity: 0; } 
      to { transform: scale(1) translateY(0); opacity: 1; } 
    }
    .chat-bubble { 
      max-width: 85%; padding: 16px 24px; border-radius: 20px; line-height: 1.7; 
      animation: message-slide-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      /* MEJORA: Optimización de rendimiento */
      will-change: transform, opacity;
    }
    @keyframes message-slide-in { 
      from { opacity: 0; transform: translateY(20px) scale(0.9); } 
      to { opacity: 1; transform: translateY(0) scale(1); } 
    }
    .chat-bubble.user { 
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border-bottom-right-radius: 6px;
    }
    .chat-bubble.ai { 
      background: linear-gradient(135deg, rgba(44, 44, 46, 0.9) 0%, rgba(30, 30, 35, 0.9) 100%); color: #e5e5e5; 
      border-left: 4px solid #007bff; border-bottom-left-radius: 6px;
    }
    .chat-bubble.error {
        background: linear-gradient(135deg, rgba(102, 28, 42, 0.9) 0%, rgba(50, 15, 20, 0.9) 100%);
        border-left: 4px solid #ff4d4d; color: #ffcccc;
    }
    .retry-button {
        background-color: rgba(255, 77, 77, 0.3); border: 1px solid rgba(255, 77, 77, 0.5);
        padding: 8px 12px; margin-top: 12px; border-radius: 8px; cursor: pointer;
        transition: background-color 0.3s;
    }
    .retry-button:hover { background-color: rgba(255, 77, 77, 0.5); }
    
    .suggestion-chip { 
      border: 1px solid rgba(0,123,255,0.2); cursor: pointer; 
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .suggestion-chip:hover { 
      border-color: #007bff; transform: translateY(-2px) scale(1.02);
      /* MEJORA: Optimización de rendimiento */
      will-change: transform;
    }
    
    .particle {
      position: absolute; background: radial-gradient(circle, rgba(0,123,255,0.8) 0%, transparent 70%);
      border-radius: 50%; animation: float 6s infinite ease-in-out;
      /* MEJORA: Optimización de rendimiento */
      will-change: transform, opacity;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
      50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
    }
    
    .shake-anim { animation: shake 0.5s ease-in-out; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25%, 75% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
    }

    /* MEJORA: Responsive para pantallas muy pequeñas */
    @media (max-width: 480px) {
      .chat-window { border-radius: 20px; }
      .chat-bubble { padding: 12px 18px; max-width: 95%; }
      #chat-form input { padding-top: 0.75rem; padding-bottom: 0.75rem; padding-left: 1rem; }
      #send-button { width: 3rem; height: 3rem; }
      .suggestion-chip { padding: 0.5rem 0.75rem; font-size: 0.8rem; }
      h1 { font-size: 2.25rem; }
    }

    @media (max-width: 768px) {
      .chat-window { width: 98%; height: 98vh; border-radius: 24px; }
      .chat-bubble { max-width: 90%; }
      #matrix-text, .glitch-char { font-size: 0.8rem; }
    }
  </style>
</head>
<body class="w-screen h-screen">

  <div id="matrix-screen" class="w-full h-full flex items-center justify-center p-4">
    <div class="matrix-rain"></div>
    <div class="w-full max-w-4xl relative z-10"><pre id="matrix-text" class="text-center"></pre></div>
  </div>

  <div id="glitch-screen" class="hidden opacity-0">
    <div class="particles"></div>
    <div id="glitch-container" class="p-8"></div>
    <div id="loading-bar-container"><div id="loading-bar"></div></div>
  </div>

  <div id="login-screen" class="w-full h-full flex flex-col items-center justify-center p-4 z-10 absolute top-0 left-0 opacity-0 hidden">
    <div class="text-center w-full max-w-md slide-up">
      <div class="relative mb-8"><i class="fas fa-shield-alt text-7xl text-blue-500 ai-pulse"></i></div>
      <h1 class="text-4xl md:text-5xl font-bold mb-3 bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">Protocolo VIERNES</h1>
      <p class="text-xl text-gray-300 mb-10 font-light">Acceso restringido. Por favor, identifíquese.</p>
      <form id="password-form" class="w-full space-y-6">
        <input type="password" id="password-input" class="w-full bg-gray-900/50 border-2 border-gray-700 text-white text-xl rounded-2xl p-5 text-center focus:outline-none focus:border-blue-500 transition-all" placeholder="••••••••••" aria-label="Campo de contraseña">
        <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 text-white font-bold text-xl py-5 rounded-2xl transition-transform transform hover:scale-105" aria-label="Desbloquear Sistema"><i class="fas fa-unlock-alt mr-3"></i>Desbloquear</button>
      </form>
      <p id="error-message" class="text-red-400 mt-6 h-6 font-medium"></p>
    </div>
  </div>
  
  <div id="chat-screen" class="w-full h-full opacity-0 hidden items-center justify-center">
    <div class="particles"></div>
    <div class="chat-window flex flex-col">
        <header class="chat-header p-6 text-center flex-shrink-0">
            <h2 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">VIERNES</h2>
            <p class="text-sm text-gray-400 mt-1 font-light">Asistente Digital de Juan Carlos Fernández</p>
        </header>
        
        <main id="chat-log" role="main" aria-live="polite" class="flex-1 p-6 md:p-8 space-y-8 overflow-y-auto"></main>

        <footer class="p-6 flex-shrink-0">
            <div id="suggestion-chips-container" class="suggestion-chips flex flex-wrap justify-center gap-3 mb-6">
                <div class="suggestion-chip text-sm py-3 px-5 rounded-full font-medium"><i class="fas fa-briefcase mr-2"></i>Experiencia</div>
                <div class="suggestion-chip text-sm py-3 px-5 rounded-full font-medium"><i class="fas fa-star mr-2"></i>Habilidades</div>
                <div class="suggestion-chip text-sm py-3 px-5 rounded-full font-medium"><i class="fas fa-handshake mr-2"></i>Proyectos</div>
            </div>
            <form id="chat-form" class="flex items-center gap-4">
                <input type="text" id="user-input" class="flex-1 w-full bg-black/30 border-2 border-white/10 rounded-full py-4 px-6 focus:outline-none focus:border-blue-500 transition" placeholder="Pregunta algo sobre Juan Carlos..." autocomplete="off" aria-label="Escribe tu pregunta">
                <button type="submit" id="send-button" class="bg-blue-600 rounded-full w-14 h-14 flex items-center justify-center transition-transform hover:scale-110 flex-shrink-0" aria-label="Enviar"><i class="fas fa-paper-plane text-lg"></i></button>
            </form>
        </footer>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Selectores del DOM
    const matrixScreen = document.getElementById('matrix-screen');
    const matrixTextElement = document.getElementById('matrix-text');
    const matrixRain = document.querySelector('.matrix-rain');
    const glitchScreen = document.getElementById('glitch-screen');
    const glitchContainer = document.getElementById('glitch-container');
    const loadingBar = document.getElementById('loading-bar');
    const loginScreen = document.getElementById('login-screen');
    const passwordForm = document.getElementById('password-form');
    const passwordInput = document.getElementById('password-input');
    const errorMessage = document.getElementById('error-message');
    const chatScreen = document.getElementById('chat-screen');
    const chatLog = document.getElementById('chat-log');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const suggestionChipsContainer = document.getElementById('suggestion-chips-container');
    
    // BUG FIX: Gestión de timeouts para evitar memory leaks
    let activeTimeouts = [];

    // MEJORA DE SEGURIDAD: Se usa un hash SHA-256 en lugar de texto plano o Base64.
    // Hash pre-calculado para la contraseña 'VIERNES13'
    const CORRECT_PASSWORD_HASH = '3b6de8182f8072124508316368d4de273932c634125748805f5b6205792a472c';

    // --- FUNCIONES DE SEGURIDAD Y UTILIDAD ---
    
    // MEJORA: Función para hashear la contraseña con SHA-256
    async function digestMessage(message) {
      const msgUint8 = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // MEJORA: Función para sanitizar la entrada del usuario y prevenir XSS simple.
    function sanitizeInput(text) {
        const temp = document.createElement('div');
        temp.textContent = text;
        return temp.innerHTML;
    }
    
    // BUG FIX: Limpia todos los timeouts activos.
    function clearAllActiveTimeouts() {
        activeTimeouts.forEach(id => clearTimeout(id));
        activeTimeouts = [];
    }
    
    function newTimeout(callback, delay) {
        const id = setTimeout(callback, delay);
        activeTimeouts.push(id);
        return id;
    }

    // --- SECUENCIA DE INICIO ---

    function createMatrixRain() {
        // BUG FIX: Limpiar el contenedor antes de añadir nuevas columnas para evitar duplicación.
        matrixRain.innerHTML = '';
        const chars = '01アイウエオカキクケコサシスセソタチツテトナニヌネノ';
        const columns = Math.floor(window.innerWidth / 20);
        for (let i = 0; i < columns; i++) {
            const column = document.createElement('div');
            column.className = 'matrix-column';
            column.style.left = i * 20 + 'px';
            column.style.animationDelay = Math.random() * 2 + 's';
            column.style.animationDuration = `${Math.random() * 3 + 2}s`;
            column.textContent = Array.from({ length: 20 }, () => chars[Math.floor(Math.random() * chars.length)]).join('\n');
            matrixRain.appendChild(column);
        }
    }

    function createParticles(container) {
        // BUG FIX: Limpiar el contenedor.
        container.innerHTML = '';
        for (let i = 0; i < 15; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.top = `${Math.random() * 100}%`;
            const size = `${Math.random() * 4 + 2}px`;
            particle.style.width = particle.style.height = size;
            particle.style.animationDelay = `${Math.random() * 6}s`;
            particle.style.animationDuration = `${Math.random() * 4 + 4}s`;
            container.appendChild(particle);
        }
    }

    function typeWriter(text, element, index, callback) {
        if (index < text.length) {
            element.innerHTML = sanitizeInput(text.substring(0, index + 1)) + '<span class="blinking-cursor"></span>';
            const speed = text[index] === '\n' ? 100 : Math.random() * 50 + 30;
            newTimeout(() => typeWriter(text, element, index + 1, callback), speed);
        } else {
            element.innerHTML = sanitizeInput(text);
            if (callback) newTimeout(callback, 800);
        }
    }

    function runIntroSequence() {
        createMatrixRain();
        const introText = `> SISTEMA INICIANDO...\n> PROTOCOLO VIERNES ACTIVADO\n\nADVERTENCIA: ACCESO RESTRINGIDO\nPreparando interfaz de autenticación...`;
        
        typeWriter(introText, matrixTextElement, 0, () => {
            clearAllActiveTimeouts();
            matrixScreen.classList.add('fade-out');
            newTimeout(() => {
                glitchScreen.classList.remove('hidden');
                glitchScreen.classList.add('fade-in');
                runGlitchSequence();
            }, 600);
        });
    }

    function runGlitchSequence() {
        createParticles(glitchScreen.querySelector('.particles'));
        requestAnimationFrame(() => { loadingBar.style.width = '100%'; });

        newTimeout(() => {
            clearAllActiveTimeouts();
            glitchScreen.classList.add('fade-out');
            newTimeout(() => {
                loginScreen.classList.remove('hidden');
                loginScreen.classList.add('fade-in');
                passwordInput.focus();
            }, 600);
        }, 8000); // Duración de la barra de carga
    }

    // --- LÓGICA DE LOGIN ---

    passwordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = passwordInput.value;
        const hash = await digestMessage(password);
        
        if (hash === CORRECT_PASSWORD_HASH) {
            loginScreen.classList.remove('fade-in');
            loginScreen.classList.add('fade-out');
            newTimeout(() => {
                chatScreen.classList.remove('hidden');
                chatScreen.classList.add('fade-in');
                createParticles(chatScreen.querySelector('.particles'));
                appendMessage("<strong>Sistema activado.</strong> Soy Viernes. He analizado la trayectoria profesional de Juan Carlos. ¿Qué información necesitas?", 'ai');
                userInput.focus();
            }, 600);
        } else {
            errorMessage.textContent = 'Acceso denegado.';
            passwordInput.classList.add('shake-anim');
            passwordInput.value = '';
            newTimeout(() => { 
                errorMessage.textContent = ''; 
                passwordInput.classList.remove('shake-anim');
            }, 2000);
        }
    });

    // --- LÓGICA DEL CHAT ---
    const chatHistory = [];
    const CV_CONTEXT = `...`; // El contexto del CV no cambia
    chatHistory.push({ role: "system", parts: [{ text: CV_CONTEXT }] });

    let lastUserMessage = '';

    // BUG FIX: Limitar el tamaño del historial de chat.
    function trimChatHistory() {
        const maxHistoryLength = 20; // 10 pares de mensajes
        if (chatHistory.length > maxHistoryLength + 1) { // +1 por el system prompt
            // Elimina los mensajes más antiguos, excepto el prompt del sistema
            chatHistory.splice(1, chatHistory.length - (maxHistoryLength + 1));
        }
    }

    suggestionChipsContainer.addEventListener('click', (e) => {
        const chip = e.target.closest('.suggestion-chip');
        if (chip) {
            userInput.value = chip.textContent.trim().replace(/.*?\s/, '');
            chatForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
        }
    });
    
    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const rawUserMessage = userInput.value.trim();
        if (!rawUserMessage) return;

        // MEJORA: Sanitizar la entrada antes de usarla
        lastUserMessage = sanitizeInput(rawUserMessage);
        
        handleUserMessage(lastUserMessage);
    });

    async function handleUserMessage(message) {
        if (suggestionChipsContainer.style.opacity !== '0') {
            suggestionChipsContainer.style.opacity = '0';
            newTimeout(() => suggestionChipsContainer.style.display = 'none', 500);
        }

        appendMessage(message, 'user');
        userInput.value = '';
        showTypingIndicator();
        
        try {
            const aiResponse = await getAIResponse(message);
            removeTypingIndicator();
            appendMessage(aiResponse, 'ai');
        } catch (error) {
            removeTypingIndicator();
            // MEJORA: Manejo de errores específico con botón de reintento
            appendMessage(error.message, 'error', true);
            console.error('Error fetching AI response:', error);
        }
    }
  
    function appendMessage(text, sender, isError = false) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `w-full flex items-start gap-4 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
        const bubble = document.createElement('div');
        bubble.className = `chat-bubble ${sender}`;

        if (sender === 'user') {
            bubble.textContent = text;
        } else {
            bubble.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }

        if (isError) {
             const retryButton = document.createElement('button');
             retryButton.className = 'retry-button';
             retryButton.textContent = 'Reintentar';
             retryButton.onclick = () => {
                 bubble.parentElement.remove();
                 handleUserMessage(lastUserMessage);
             };
             bubble.appendChild(retryButton);
        }
        
        messageWrapper.appendChild(bubble);
        chatLog.appendChild(messageWrapper);
        chatLog.scrollTop = chatLog.scrollHeight;
    }
  
    function showTypingIndicator() {
        const typingWrapper = document.createElement('div');
        typingWrapper.id = 'typing-indicator';
        typingWrapper.className = 'flex items-start gap-4 justify-start';
        typingWrapper.innerHTML = `<div class="chat-bubble ai"><div class="typing-indicator flex items-center"><span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span><span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse [animation-delay:0.2s]"></span><span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse [animation-delay:0.4s]"></span></div></div>`;
        chatLog.appendChild(typingWrapper);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    async function getAIResponse(prompt) {
        // MEJORA: La lógica de la API Key sigue aquí, con mejores mensajes de error.
        const apiKey = ""; // <-- AGREGA TU API KEY DE GOOGLE AI STUDIO AQUÍ

        if (!apiKey) throw new Error('Error de configuración: La API Key no fue proporcionada.');

        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
        trimChatHistory();

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ contents: chatHistory }) 
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            console.error("API Error:", errorData);
            throw new Error(`Error ${response.status}: La comunicación con la IA falló. Verifica la API Key y la consola.`);
        }
        
        const result = await response.json();
        const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text;

        if (aiText) {
            chatHistory.push({ role: "model", parts: [{ text: aiText }] });
            return aiText;
        } else {
            throw new Error('La IA no devolvió una respuesta válida. Inténtalo de nuevo.');
        }
    }
    
    // Iniciar la secuencia
    runIntroSequence();
});
</script>
</body>
</html>
